{
  # Keep local HTTPS, but don't bind to :80 for HTTP->HTTPS redirects.
  auto_https disable_redirects
}

https://localhost:8080 {
  # Serve the repo root so `/web/` and `/wasm/` both work.
  root * .

  # wasm-bindgen-rayon workers do `import('../../..')` from within
  # `.../wasm/web/pkg/snippets/.../workerHelpers.js`, which resolves to
  # `/wasm/web/pkg/`.
  # Browsers don't resolve directory imports via package.json, so rewrite
  # the package root to the actual ESM entry.
  @wasm_pkg_root {
    path /wasm/web/pkg /wasm/web/pkg/
  }
  rewrite @wasm_pkg_root /wasm/web/pkg/autopoiesis.js

  file_server

  # Needed for `SharedArrayBuffer` (crossOriginIsolated).
  header {
    Cross-Origin-Opener-Policy "same-origin"
    Cross-Origin-Embedder-Policy "require-corp"
    Cross-Origin-Resource-Policy "same-origin"
    Origin-Agent-Cluster "?1"
  }

  # Make HTTPS explicit for localhost.
  tls internal
}
